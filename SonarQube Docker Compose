Great catch ğŸ‘Œ â€” this is **exactly** the kind of thing a DevSecOps engineer *should* question.

Youâ€™re right: **hard-coding credentials in `docker-compose.yml` is NOT production-ready**. Letâ€™s fix this **once and permanently** for a VPS and then talk about **UAT vs Prod usage with Jenkins**.

---

# 1ï¸âƒ£ Why the official example is insecure (and why itâ€™s shown)

SonarSource docs keep it **simple for demos**, not secure for prod:

```yaml
SONAR_JDBC_USERNAME: sonar
SONAR_JDBC_PASSWORD: sonar
POSTGRES_PASSWORD: sonar
```

Problems:

* Credentials stored in Git
* Anyone with repo access gets DB access
* No rotation
* Violates SOC2 / ISO / PCI / CIS benchmarks

ğŸ‘‰ **Docs â‰  Production architecture**

---

# 2ï¸âƒ£ Production-ready approach (Permanent VPS setup)

## âœ… Golden Rule

**Secrets must never live in Git**
They must live in:

* `.env` file (restricted permissions) **OR**
* Docker secrets **OR**
* Vault (best)

For a **single VPS permanent setup**, the **best balance** is:

> âœ… `.env` file + filesystem permissions
> (Simple, secure, maintainable)

---

## 3ï¸âƒ£ Secure SonarQube Docker Compose (FIXED)

### Step 1: Create secrets file (outside Git)

```bash
sudo mkdir -p /opt/sonarqube
sudo nano /opt/sonarqube/.env
```

```env
# Database
POSTGRES_USER=sonar
POSTGRES_PASSWORD=STRONG_DB_PASSWORD
POSTGRES_DB=sonar

# SonarQube
SONAR_JDBC_URL=jdbc:postgresql://db:5432/sonar
SONAR_JDBC_USERNAME=sonar
SONAR_JDBC_PASSWORD=STRONG_DB_PASSWORD
```

ğŸ” Secure it:

```bash
sudo chown root:docker /opt/sonarqube/.env
sudo chmod 640 /opt/sonarqube/.env
```

---

### Step 2: Updated `docker-compose.yml` (SAFE)

```yaml
version: "3.8"

services:
  sonarqube:
    image: sonarqube:community
    depends_on:
      - db
    env_file:
      - .env
    volumes:
      - sonarqube_data:/opt/sonarqube/data
      - sonarqube_extensions:/opt/sonarqube/extensions
      - sonarqube_logs:/opt/sonarqube/logs
    ports:
      - "9000:9000"
    restart: always

  db:
    image: postgres:12
    env_file:
      - .env
    volumes:
      - postgresql_data:/var/lib/postgresql/data
    restart: always

volumes:
  sonarqube_data:
  sonarqube_extensions:
  sonarqube_logs:
  postgresql_data:
```

âœ” No secrets in Git
âœ” One-time permanent deployment
âœ” Restart-safe
âœ” Clean separation

---

## 4ï¸âƒ£ VPS hardening (IMPORTANT for permanent install)

Run once:

```bash
sudo sysctl -w vm.max_map_count=524288
sudo sysctl -w fs.file-max=131072
ulimit -n 131072
ulimit -u 8192
```

Persist:

```bash
sudo nano /etc/sysctl.conf
```

Add:

```conf
vm.max_map_count=524288
fs.file-max=131072
```

---

## 5ï¸âƒ£ Jenkins integration (SECURE WAY)

### ğŸš« What NOT to do

* âŒ Do NOT store DB creds in Jenkins
* âŒ Do NOT expose Sonar DB to Jenkins
* âŒ Do NOT scan Sonar from inside DB network

---

### âœ… Correct Jenkins â†” SonarQube integration

Jenkins only needs:

* **SonarQube URL**
* **SonarQube Token**

#### Step 1: Generate Sonar Token

SonarQube UI â†’
**My Account â†’ Security â†’ Generate Token**

---

#### Step 2: Store token in Jenkins (Credential Manager)

| Type  | Value            |
| ----- | ---------------- |
| Kind  | Secret Text      |
| ID    | `sonar-token`    |
| Value | `sqp_xxxxxxxxxx` |

---

#### Step 3: Jenkinsfile (Best practice)

```groovy
environment {
  SONAR_HOST_URL = "http://sonarqube.yourdomain.com:9000"
  SONAR_TOKEN    = credentials('sonar-token')
}

stage('SonarQube Analysis') {
  steps {
    sh """
    sonar-scanner \
      -Dsonar.projectKey=my-app \
      -Dsonar.sources=. \
      -Dsonar.host.url=$SONAR_HOST_URL \
      -Dsonar.login=$SONAR_TOKEN
    """
  }
}
```

âœ” Jenkins never sees DB
âœ” Token is revocable
âœ” Least privilege

---

## 6ï¸âƒ£ UAT vs PROD â€” what is recommended?

### âœ… UAT

* âœ” SonarQube Community is OK
* âœ” Single VPS is OK
* âœ” One shared Sonar instance for multiple apps

### ğŸš€ PROD

* âœ” SonarQube Developer / Enterprise recommended
* âœ” Dedicated VM / Kubernetes
* âœ” HTTPS + Reverse proxy
* âœ” Backup strategy for volumes
* âœ” DB not exposed publicly

---

## 7ï¸âƒ£ Enterprise-grade improvements (optional but recommended)

| Feature      | Tool            |
| ------------ | --------------- |
| HTTPS        | NGINX + Certbot |
| Secrets      | HashiCorp Vault |
| Backup       | Cron + rsync    |
| Auth         | LDAP / SSO      |
| Isolation    | Separate DB VM  |
| Availability | K8s + PVC       |

---

## ğŸ§  DevSecOps Verdict

âœ” Docs example â†’ **Demo only**
âœ” `.env` + permissions â†’ **Best VPS permanent fix**
âœ” Jenkins uses **tokens only**
âœ” Safe for **UAT & PROD** with hardening

---

If you want, next I can:

* ğŸ” Put SonarQube behind **NGINX + HTTPS**
* ğŸ“¦ Convert this to **Kubernetes**
* ğŸ§± Add **quality gates as pipeline gates**
* ğŸ§ª Show **DevSecOps Gate-1 (SAST) enforcement**

Just tell me ğŸ‘
