pipeline {
    agent any
tools {
        nodejs 'nodejs22'
    }
    
     environment {
        SCANNER_HOME = tool 'SONAR_SCANNER'
    }
    
    stages {
        stage('üì• Checkout Code') {
            steps {
               git branch: 'dev', changelog: false, poll: false, url: 'https://github.com/mahesharimalla/lms.git'
            }
        }
        
        stage('Compile Applications') {
    parallel {
        stage('Compile Backend') {
            steps {
                dir('api') {
                    sh '''
                      npm install
                      npm run lint
                      npm run build
                    '''
                }
            }
        }

        stage('Compile Frontend') {
            steps {
                dir('webapp') {
                    sh '''
                      npm install
                      npm run build
                    '''
                }
            }
        }
    }
}

/*
         stage('Frontend Compilation') {
            steps {
                dir('webapp') {
                    sh 'find . -name "*.js" -exec node --check {} +'
                }
            }
        }
        
        stage('Backend Compilation') {
            steps {
                dir('api') {
                    sh 'find . -name "*.js" -exec node --check {} +'
                }
            }
        }
*/

/*
     stage('üö¶ Gate-0: Pre-Merge Hygiene') {
    steps {
        script {
            echo "Running Gate-0 checks (Secrets, Lint, Tests)..."

            try {
                // 1Ô∏è‚É£ Secrets Scan (HARD FAIL)
                sh '''
                  gitleaks detect \
                  --source . \
                  --no-git \
                  --redact \
                  --exit-code 1
                '''

                echo "‚úÖ Gitleaks passed ‚Äì No secrets found"

            } catch (err) {
                echo "‚ùå Gitleaks FAILED ‚Äì Secrets detected"

                // Mark build as failed
                currentBuild.result = 'FAILURE'

                // üì£ Notify Developer
                emailext(
                    subject: "üö® Jenkins Gate-0 FAILED: Secrets Detected",
                    body: """
Hello Developer,

üö´ Gate-0 failed due to secrets detected by Gitleaks.

Job      : ${env.JOB_NAME}
Build    : #${env.BUILD_NUMBER}
Branch   : dev
Stage    : Gate-0 (Pre-Merge Hygiene)

üëâ Action Required:
- Remove hardcoded secrets
- Use environment variables / Jenkins credentials
- Re-run pipeline after fixing

Build URL:
${env.BUILD_URL}

-- DevSecOps CI
""",
                    to: 'dev-team@company.com'
                )

                // Stop pipeline immediately
                error("Stopping pipeline ‚Äì Secrets must be fixed by developer")
            }

            // Continue only if gitleaks passed
            sh 'npm install'
            sh 'npm run lint'
            sh 'npm test -- --ci'
        }
    }
}

*/

stage('SonarQube Analysis') {
            steps {
                withSonarQubeEnv('SONAR') {
                    sh ''' $SCANNER_HOME/bin/sonar-scanner -Dsonar.projectName=lms \
                            -Dsonar.projectKey=lms '''
                }
            }
        }

stage('Gate-1: SAST (SonarQube)') {
    steps {
        script {
            try {
                timeout(time: 10, unit: 'MINUTES') {
                    def qg = waitForQualityGate()

                    echo "Gate-1 Status: ${qg.status}"

                    // ‚úÖ If Quality Gate passed ‚Üí continue
                    if (qg.status == 'OK') {
                        echo "Quality Gate passed. No approval required."
                    }
                    // ‚ùå If failed / warn / pending ‚Üí approval required
                    else {
                        def approval = input(
                            message: """
Gate-1 (SAST) did NOT pass ‚ùå

SonarQube Status: ${qg.status}

Component AO approval is required to continue.
""",
                            ok: 'Approve & Continue',
                            parameters: [
                                string(
                                    name: 'JUSTIFICATION',
                                    defaultValue: '',
                                    description: 'Why is this risk acceptable? (Ticket / Reason)'
                                )
                            ]
                        )

                        echo "Gate-1 approved by Component AO. Justification: ${approval}"
                    }
                }
            }
            // ‚è≥ Handles SonarQube stuck / timeout case
            catch (err) {
                def approval = input(
                    message: """
Gate-1 (SAST) TIMEOUT ‚è≥

SonarQube did not return a Quality Gate result in time.

Component AO approval is required to continue.
""",
                    ok: 'Approve & Continue',
                    parameters: [
                        string(
                            name: 'JUSTIFICATION',
                            defaultValue: '',
                            description: 'Why is this risk acceptable? (Ticket / Reason)'
                        )
                    ]
                )

                echo "Gate-1 approved after timeout. Justification: ${approval}"
            }
        }
    }
}


stage('üõ°Ô∏è OWASP Dependency Check') {

    steps {
        script {
            echo "Running OWASP Dependency-Check with Quality Gates..."

            sh """
              ${DC_HOME}/bin/dependency-check.sh \
                --project "LMS-Application" \
                --scan . \
                --format XML \
                --out dependency-check-report \
                --failOnCVSS 7
            """
        }
    }

    post {

        success {
            echo "‚úÖ Dependency-Check PASSED (No HIGH / CRITICAL vulnerabilities)"

            /* ---------- Component AO Approval ---------- */
            timeout(time: 24, unit: 'HOURS') {
                input message: 'Approve OWASP Dependency Check results?',
                      ok: 'Approve',
                      submitter: 'component-ao'   // Jenkins user or group
            }

            /* ---------- Inform Security AO ---------- */
            emailext (
                subject: "‚úÖ OWASP Dependency Check PASSED | Component AO Approved",
                body: """
Hello Security AO,

OWASP Dependency-Check has PASSED successfully.

‚úî No HIGH or CRITICAL vulnerabilities found
‚úî Approved by Component AO
‚úî Pipeline: ${env.JOB_NAME} #${env.BUILD_NUMBER}

You may review the report in Jenkins.

Regards,
Jenkins DevSecOps Pipeline
""",
                to: 'security-ao@company.com'
            )
        }



        failure {
            echo "‚ùå Dependency-Check FAILED (HIGH / CRITICAL vulnerabilities found)"

            emailext (
                subject: "üö® OWASP Dependency Check FAILED | Pipeline Stopped",
                body: """
Hello Security AO,

OWASP Dependency-Check has FAILED.

‚ùå HIGH or CRITICAL vulnerabilities detected
‚ùå Pipeline execution STOPPED
‚ùå Job: ${env.JOB_NAME} #${env.BUILD_NUMBER}

Immediate remediation required.

Regards,
Jenkins DevSecOps Pipeline
""",
                to: 'security-ao@company.com'
            )
        }
    }
    

}

    }
}
